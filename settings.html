<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beecy Admin - Configuraci√≥n</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1>Beecy Admin</h1>
                <div class="header-actions">
                    <button class="btn btn-settings" onclick="window.location.href='index.html'">Volver al
                        Panel</button>
                    <button class="btn btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </header>
        <main class="app-main">
            <div class="main-content">
                <div class="page-header">
                    <h2>Configuraci√≥n</h2>
                    <p class="page-description">Gestiona usuarios y personaliza la apariencia del panel de
                        administraci√≥n</p>
                </div>
                <div id="message-container" class="message-container"></div>

                <!-- Card 1: Buscar Usuario -->
                <div class="settings-card">
                    <div class="settings-section">
                        <h3 class="settings-section-title">Buscar Usuario</h3>
                        <p class="page-description" style="margin-bottom: 24px;">Busca un usuario por su n√∫mero de
                            tel√©fono para editar su perfil o cambiar su n√∫mero</p>
                        <form id="search-user-form" class="login-form" onsubmit="handleSearchUser(event)">
                            <div class="form-group">
                                <label for="search-phone">N√∫mero de Tel√©fono</label>
                                <input type="tel" id="search-phone" name="search-phone" placeholder="+573001234567"
                                    required autocomplete="tel" pattern="^\+[1-9]\d{9,14}$">
                                <small class="form-hint">Formato internacional (ej: +573001234567)</small>
                            </div>
                            <button type="submit" class="btn btn-primary" id="search-btn">
                                Buscar Usuario
                            </button>
                        </form>
                        <div id="user-info-container"
                            style="display: none; margin-top: 24px; padding: 20px; background: var(--surface-elevated); border-radius: var(--radius); border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Informaci√≥n del Usuario</h4>
                            <div id="user-info-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Editar Perfil -->
                <div class="settings-card" id="edit-profile-card" style="display: none;">
                    <div class="settings-section">
                        <h3 class="settings-section-title">Editar Perfil</h3>
                        <p class="page-description" style="margin-bottom: 24px;">Modifica la informaci√≥n del usuario
                            encontrado</p>
                        <form id="edit-profile-form" class="login-form" onsubmit="handleUpdateProfile(event)">
                            <div class="form-group">
                                <label for="profile-name">Nombre</label>
                                <input type="text" id="profile-name" name="profile-name"
                                    placeholder="Nombre del usuario">
                            </div>
                            <div class="form-group">
                                <label for="profile-email">Email</label>
                                <input type="email" id="profile-email" name="profile-email"
                                    placeholder="email@ejemplo.com">
                            </div>
                            <div class="form-group">
                                <label for="profile-phone-display">Tel√©fono Actual</label>
                                <input type="text" id="profile-phone-display" name="profile-phone-display" readonly
                                    style="background: var(--surface); cursor: not-allowed;">
                            </div>
                            <button type="submit" class="btn btn-primary" id="save-profile-btn">
                                Guardar Cambios
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Card 3: Cambiar N√∫mero de Tel√©fono -->
                <div class="settings-card" id="change-phone-card" style="display: none;">
                    <div class="settings-section">
                        <h3 class="settings-section-title">Cambiar N√∫mero de Tel√©fono</h3>
                        <p class="page-description" style="margin-bottom: 24px;">Cambia el n√∫mero de tel√©fono del
                            usuario encontrado</p>

                        <!-- Estado 1: Solicitar OTP -->
                        <div id="request-otp-section">
                            <form id="change-phone-form" class="login-form" onsubmit="handleRequestChangePhone(event)">
                                <div class="form-group">
                                    <label for="current-phone-display">Tel√©fono Actual</label>
                                    <input type="text" id="current-phone-display" name="current-phone-display" readonly
                                        style="background: var(--surface); cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label for="new-phone">Nuevo N√∫mero de Tel√©fono</label>
                                    <input type="tel" id="new-phone" name="new-phone" placeholder="+573001234567"
                                        required autocomplete="tel" pattern="^\+[1-9]\d{9,14}$">
                                    <small class="form-hint">Formato internacional (ej: +573001234567)</small>
                                </div>
                                <button type="submit" class="btn btn-primary" id="request-otp-btn">
                                    Enviar C√≥digo OTP
                                </button>
                            </form>
                        </div>

                        <!-- Estado 2: Verificar OTP -->
                        <div id="verify-otp-section" style="display: none;">
                            <form id="verify-change-phone-form" class="login-form"
                                onsubmit="handleVerifyChangePhone(event)">
                                <div class="form-group">
                                    <label for="new-phone-display">Nuevo N√∫mero de Tel√©fono</label>
                                    <input type="text" id="new-phone-display" name="new-phone-display" readonly
                                        style="background: var(--surface); cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label for="change-phone-otp">C√≥digo OTP</label>
                                    <input type="text" id="change-phone-otp" name="change-phone-otp"
                                        placeholder="000000" required autocomplete="one-time-code" maxlength="6"
                                        pattern="\d{6}" inputmode="numeric">
                                    <small class="form-hint">Ingresa el c√≥digo de 6 d√≠gitos enviado al nuevo
                                        n√∫mero</small>
                                </div>
                                <button type="submit" class="btn btn-primary" id="confirm-change-btn">
                                    Confirmar Cambio
                                </button>
                                <button type="button" class="btn btn-link" onclick="cancelChangePhone()">
                                    Cancelar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Card 4: Tema de la Aplicaci√≥n -->
                <div class="settings-card">
                    <div class="settings-section">
                        <h3 class="settings-section-title">Tema de la Aplicaci√≥n</h3>
                        <p class="page-description" style="margin-bottom: 24px;">Elige entre modo oscuro o claro seg√∫n
                            tu preferencia</p>
                        <div class="theme-selector">
                            <div class="theme-option" id="theme-dark" onclick="selectTheme('dark')">
                                <span class="theme-option-icon">üåô</span>
                                <div class="theme-option-title">Modo Oscuro</div>
                                <div class="theme-option-description">Ideal para trabajar en ambientes con poca luz
                                </div>
                            </div>
                            <div class="theme-option" id="theme-light" onclick="selectTheme('light')">
                                <span class="theme-option-icon">‚òÄÔ∏è</span>
                                <div class="theme-option-title">Modo Claro</div>
                                <div class="theme-option-description">Ideal para trabajar en ambientes con mucha luz
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentUser = null;
        let newPhoneNumber = null;

        function selectTheme(theme) {
            setTheme(theme);
            updateThemeSelector(theme);
            const messageContainer = document.getElementById('message-container');
            if (messageContainer) {
                const themeName = theme === 'dark' ? 'oscuro' : 'claro';
                showSuccess(`Tema ${themeName} aplicado correctamente`, messageContainer);
            }
        }

        function updateThemeSelector(activeTheme) {
            const darkOption = document.getElementById('theme-dark');
            const lightOption = document.getElementById('theme-light');

            if (darkOption && lightOption) {
                darkOption.classList.toggle('active', activeTheme === 'dark');
                lightOption.classList.toggle('active', activeTheme === 'light');
            }
        }

        async function handleSearchUser(event) {
            event.preventDefault();
            const phoneInput = document.getElementById('search-phone');
            const searchBtn = document.getElementById('search-btn');
            const messageContainer = document.getElementById('message-container');
            const phone = phoneInput.value.trim();
            const formattedPhone = formatPhone(phone);

            if (!validatePhone(formattedPhone)) {
                showError('Formato de tel√©fono inv√°lido. Debe ser un n√∫mero internacional (ej: +573001234567)', messageContainer);
                phoneInput.focus();
                return;
            }

            searchBtn.disabled = true;
            searchBtn.textContent = 'Buscando...';
            clearMessage(messageContainer);

            try {
                const user = await getUserByPhone(formattedPhone);
                currentUser = user;
                displayUserInfo(user);
                showSuccess('Usuario encontrado correctamente', messageContainer);
            } catch (error) {
                showError(error.message || 'Error al buscar usuario. Verifica el n√∫mero de tel√©fono.', messageContainer);
                hideUserSections();
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Buscar Usuario';
            }
        }

        function displayUserInfo(user) {
            const userInfoContainer = document.getElementById('user-info-container');
            const userInfoContent = document.getElementById('user-info-content');
            const editProfileCard = document.getElementById('edit-profile-card');
            const changePhoneCard = document.getElementById('change-phone-card');

            if (userInfoContainer && userInfoContent) {
                const userPhone = user.phone || user.phoneNumber || 'No disponible';
                const userName = user.name || user.username || 'No disponible';
                const userEmail = user.email || 'No disponible';
                const userId = user.id || user._id || 'No disponible';

                userInfoContent.innerHTML = `
                    <div style="display: grid; gap: 12px;">
                        <div><strong>ID:</strong> <span>${escapeHtml(String(userId))}</span></div>
                        <div><strong>Nombre:</strong> <span>${escapeHtml(String(userName))}</span></div>
                        <div><strong>Email:</strong> <span>${escapeHtml(String(userEmail))}</span></div>
                        <div><strong>Tel√©fono:</strong> <span>${escapeHtml(String(userPhone))}</span></div>
                    </div>
                `;
                userInfoContainer.style.display = 'block';

                // Llenar formulario de editar perfil
                if (document.getElementById('profile-name')) {
                    document.getElementById('profile-name').value = userName;
                }
                if (document.getElementById('profile-email')) {
                    document.getElementById('profile-email').value = userEmail;
                }
                if (document.getElementById('profile-phone-display')) {
                    document.getElementById('profile-phone-display').value = userPhone;
                }
                if (document.getElementById('current-phone-display')) {
                    document.getElementById('current-phone-display').value = userPhone;
                }

                // Mostrar secciones de editar perfil y cambiar tel√©fono
                if (editProfileCard) editProfileCard.style.display = 'block';
                if (changePhoneCard) changePhoneCard.style.display = 'block';
            }
        }

        function hideUserSections() {
            const userInfoContainer = document.getElementById('user-info-container');
            const editProfileCard = document.getElementById('edit-profile-card');
            const changePhoneCard = document.getElementById('change-phone-card');

            if (userInfoContainer) userInfoContainer.style.display = 'none';
            if (editProfileCard) editProfileCard.style.display = 'none';
            if (changePhoneCard) changePhoneCard.style.display = 'none';

            currentUser = null;
            resetChangePhoneForm();
        }

        async function handleUpdateProfile(event) {
            event.preventDefault();
            const saveBtn = document.getElementById('save-profile-btn');
            const messageContainer = document.getElementById('message-container');

            if (!currentUser) {
                showError('Primero debes buscar un usuario', messageContainer);
                return;
            }

            const userId = currentUser.id || currentUser._id;
            const profileData = {
                name: document.getElementById('profile-name').value.trim(),
                email: document.getElementById('profile-email').value.trim()
            };

            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            clearMessage(messageContainer);

            try {
                await updateProfile(userId, profileData);
                showSuccess('Perfil actualizado correctamente', messageContainer);
                // Recargar informaci√≥n del usuario
                const phone = currentUser.phone || currentUser.phoneNumber;
                if (phone) {
                    const user = await getUserByPhone(phone);
                    currentUser = user;
                    displayUserInfo(user);
                }
            } catch (error) {
                showError(error.message || 'Error al actualizar el perfil', messageContainer);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Cambios';
            }
        }

        async function handleRequestChangePhone(event) {
            event.preventDefault();
            const newPhoneInput = document.getElementById('new-phone');
            const requestOtpBtn = document.getElementById('request-otp-btn');
            const messageContainer = document.getElementById('message-container');

            if (!currentUser) {
                showError('Primero debes buscar un usuario', messageContainer);
                return;
            }

            const newPhone = newPhoneInput.value.trim();
            const formattedPhone = formatPhone(newPhone);

            if (!validatePhone(formattedPhone)) {
                showError('Formato de tel√©fono inv√°lido. Debe ser un n√∫mero internacional (ej: +573001234567)', messageContainer);
                newPhoneInput.focus();
                return;
            }

            requestOtpBtn.disabled = true;
            requestOtpBtn.textContent = 'Enviando...';
            clearMessage(messageContainer);

            try {
                // Enviar OTP al nuevo n√∫mero usando el endpoint de request-otp
                await sendOtp(formattedPhone);
                newPhoneNumber = formattedPhone;
                showSuccess('C√≥digo OTP enviado al nuevo n√∫mero de tel√©fono', messageContainer);

                // Cambiar a estado de verificaci√≥n
                document.getElementById('request-otp-section').style.display = 'none';
                document.getElementById('verify-otp-section').style.display = 'block';
                document.getElementById('new-phone-display').value = formattedPhone;
                document.getElementById('change-phone-otp').focus();
            } catch (error) {
                showError(error.message || 'Error al enviar c√≥digo OTP', messageContainer);
            } finally {
                requestOtpBtn.disabled = false;
                requestOtpBtn.textContent = 'Enviar C√≥digo OTP';
            }
        }

        async function handleVerifyChangePhone(event) {
            event.preventDefault();
            const otpInput = document.getElementById('change-phone-otp');
            const confirmBtn = document.getElementById('confirm-change-btn');
            const messageContainer = document.getElementById('message-container');

            if (!newPhoneNumber) {
                showError('Error: n√∫mero de tel√©fono no encontrado', messageContainer);
                return;
            }

            const otp = otpInput.value.trim();

            if (!validateOTP(otp)) {
                showError('El c√≥digo OTP debe tener 6 d√≠gitos', messageContainer);
                otpInput.focus();
                return;
            }

            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Confirmando...';
            clearMessage(messageContainer);

            try {
                await changePhone(newPhoneNumber, otp);
                showSuccess('N√∫mero de tel√©fono cambiado correctamente', messageContainer);

                // Actualizar informaci√≥n del usuario
                const user = await getUserByPhone(newPhoneNumber);
                currentUser = user;
                displayUserInfo(user);

                // Resetear formulario
                resetChangePhoneForm();
            } catch (error) {
                showError(error.message || 'Error al cambiar el n√∫mero de tel√©fono', messageContainer);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirmar Cambio';
            }
        }

        function cancelChangePhone() {
            resetChangePhoneForm();
            const messageContainer = document.getElementById('message-container');
            if (messageContainer) {
                clearMessage(messageContainer);
            }
        }

        function resetChangePhoneForm() {
            document.getElementById('request-otp-section').style.display = 'block';
            document.getElementById('verify-otp-section').style.display = 'none';
            document.getElementById('new-phone').value = '';
            document.getElementById('change-phone-otp').value = '';
            newPhoneNumber = null;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Validaci√≥n en tiempo real del tel√©fono de b√∫squeda
        document.addEventListener('DOMContentLoaded', function () {
            requireAuth();
            initTheme();
            const currentTheme = getTheme();
            updateThemeSelector(currentTheme);

            const searchPhoneInput = document.getElementById('search-phone');
            if (searchPhoneInput) {
                searchPhoneInput.addEventListener('input', function (e) {
                    let value = e.target.value;
                    value = value.replace(/[^\d+]/g, '');
                    if (value && !value.startsWith('+')) {
                        value = '+' + value.replace(/^\+/, '');
                    }
                    e.target.value = value;
                });
            }

            const newPhoneInput = document.getElementById('new-phone');
            if (newPhoneInput) {
                newPhoneInput.addEventListener('input', function (e) {
                    let value = e.target.value;
                    value = value.replace(/[^\d+]/g, '');
                    if (value && !value.startsWith('+')) {
                        value = '+' + value.replace(/^\+/, '');
                    }
                    e.target.value = value;
                });
            }

            const changePhoneOtpInput = document.getElementById('change-phone-otp');
            if (changePhoneOtpInput) {
                changePhoneOtpInput.addEventListener('input', function (e) {
                    let value = e.target.value;
                    value = value.replace(/\D/g, '');
                    value = value.substring(0, 6);
                    e.target.value = value;
                });
            }
        });
    </script>
</body>

</html>